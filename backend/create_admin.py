"""
Agregator Service - –°–æ–∑–¥–∞–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
"""

import sys
from pathlib import Path
from datetime import datetime

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É
project_root = Path(__file__).parent
sys.path.insert(0, str(project_root))

from database import SessionLocal
from models import User, UserRole
from sqlalchemy import text
from api.v1.dependencies import get_password_hash

def create_admin():
    """–°–æ–∑–¥–∞–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"""
    db = SessionLocal()
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
        existing_admin = db.execute(text("SELECT id FROM users WHERE username = 'admin'")).fetchone()
        
        if existing_admin:
            print("‚úÖ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
            # –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞—Ä–æ–ª—å
            hashed_password = get_password_hash("admin123")
            db.execute(text("UPDATE users SET hashed_password = :password WHERE username = 'admin'"), {"password": hashed_password})
            db.commit()
            print("‚úÖ –ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω")
        else:
            # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
            hashed_password = get_password_hash("admin123")
            db.execute(text("""
                INSERT INTO users (username, email, hashed_password, first_name, last_name, middle_name, role, is_active, created_at)
                VALUES ('admin', 'admin@agregator.com', :password, '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä', '–°–∏—Å—Ç–µ–º–∞', 'admin', 'admin', true, NOW())
            """), {"password": hashed_password})
            db.commit()
            print("‚úÖ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–æ–∑–¥–∞–Ω")
        
        print("üë§ –õ–æ–≥–∏–Ω: admin")
        print("üîë –ü–∞—Ä–æ–ª—å: admin123")
        print("üåê URL: http://localhost:8001")
    except Exception as e:
        db.rollback()
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
    finally:
        db.close()

if __name__ == "__main__":
    create_admin()